<meta charset="utf-8">
<script>

    function processHash(){
        let text = decodeURIComponent(location.hash.substring(1))
        text = text.replaceAll('|', "\n")
        document.getElementById('code').value = text
    }

    window.addEventListener("hashchange", processHash)
    window.addEventListener("load", processHash)

    function build()
    {
        const code = document.getElementById('code').value

        const bits = code2bits(code)
        const hex = code2hex(code)
        const bitsLen = bits.replace(/\D+/g, '').length;

        let result = ''
        result += 'bLen: ' + bitsLen+ "\n"
        result += `bits: ${bits} \n`
        result += `hex : ${hex} (${hex.length / 2} bytes) \n`

        document.getElementById('output').value = result
    }

    function code2bits(code)
    {
        code = code.replace(/\n+/g, "\n")
        const lines = code.trim().split("\n")
        console.log(lines)

        let bits = ''

        for(const p of lines){
            if(p[0] == '#') continue

            if(p.match(/^\[\d+\]\s*\d+.*$/)){
                const size  = p.match(/^\[(\d+)\]/)[1]
                const value = p.match(/^\[\d+\]\s*(\d+)/)[1]
                console.log(size)
                console.log(value)
                const valueBinary = parseInt(value).toString(2)
                if(valueBinary.length <= size){
                    bits += valueBinary.padStart(size, '0')
                }
                else{
                    alert('overflow: '+ value + ' needs ' + valueBinary.length + ' bits')
                    bits += '#overflow'
                }
                bits += ' '
            }
            else{
                alert('wrong format: ' + p)
            }
        }

        return bits
    }

    function code2hex(code)
    {
        const bits = code2bits(code)
        const binaryString = bits.replace(/\s+/g, '')

        let output = ''

        // For every 4 bits in the binary string
        for (let i = 0; i < binaryString.length; i += 4)
        {
            // Grab a chunk of 4 bits
            const bytes = binaryString.substr(i, 4)
            console.log('bytes', bytes)

            // Convert to decimal then hexadecimal
            const decimal = parseInt(bytes, 2)
            console.log('decimal', decimal)
            const hex = decimal.toString(16)
            console.log('hex', hex)

            // Uppercase all the letters and append to output
            output += hex.toUpperCase();
        }

        return output;
    }

    function createUrl(code)
    {
        const currentUrl = location.protocol+'//'+
            location.host+
            location.pathname+
            (location.search?location.search:"")

        return currentUrl + '#' + code.replace(/\n/g, '|')
    }

</script>


<br>
<br>
<br>
<br>

<button onclick="location.href = '#'">CLEAR</button>
<a href="javascript:" onclick="prompt('COPY URL HERE:',createUrl(document.getElementById('code').value))">get link</a>
<br>
<br>

<div style="display: flex">

    <textarea id=code cols=60 rows=25 style=""></textarea>
    <div style="margin-left: 100px">
        Format hint:
        <pre>#commented line<br>[{size}] {value} {description}<br>[{size}] {value} {description}<br>...</pre>
        Examples:<br>
        <a href="## сообщение OFTEN (1 фаза)||[3] 0  cmd|[1] 0  флаг экспорта|[6] 0  год|[4] 11 месяц|[5] 18 день|[5] 23 час|[1] 1  получас||[3] 2  номер тарифа|[23] 0 актив|[23] 8388607 реакт|[6] 0 напр">Electro10 Often (1 фаза)</a><br>
        <a href="## сообщение OFTEN (3 фазы)||[3] 1  cmd|[1] 0  флаг экспорта|[6] 0  год|[4] 11 месяц|[5] 18 день|[5] 23 час|[1] 1  получас||[3]  2  номер тарифа|[23] 0 фаза1 актив |[23] 0 фаза1 реакт|[6]  0 фаза1 напр|[23] 0 фаза2 актив |[23] 0 фаза2 реакт|[6]  0 фаза2 напр|[23] 0 фаза3 актив |[23] 0 фаза3 реакт|[6]  0 фаза3 напр">Electro10 Often (3 фазы)</a><br>
    </div>
</div>


<br>
<button onclick="build()">BUILD</button>
<br>
<br>

<textarea id=output rows=5 style="width: 100%">
</textarea>
