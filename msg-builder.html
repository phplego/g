<meta charset="utf-8">
<script>

    function processHash(){
        let text = decodeURIComponent(location.hash.substring(1))
        text = text.replaceAll('|', "\n")
        document.getElementById('scheme').value = text
    }

    window.addEventListener("hashchange", processHash)
    window.addEventListener("load", processHash)

    function build()
    {
        const scheme = document.getElementById('scheme').value

        const bits = scheme2bits(scheme)
        const hex = scheme2hex(scheme)
        const bitsLen = bits.replace(/\D+/g, '').length;

        let result = ''
        result += 'bLen: ' + bitsLen+ "\n"
        result += `bits: ${bits} \n`
        result += `hex : ${hex} (${hex.length / 2} bytes) \n`

        document.getElementById('hex').value = hex
        document.getElementById('output').value = result
    }

    function compile(scheme) {
        const lines = scheme.trim().split("\n")

        let fields = []

        for(const line of lines){
            if(line[0] === '#') continue
            if(line.trim() === '') continue

            const item = {}
            item.line = line
            if(line.match(/^\[\d+]\s*\d+.*$/)){
                item.size  = parseInt(line.match(/^\[(\d+)]/)[1])
                item.value = parseInt(line.match(/^\[\d+]\s*(\d+)/)[1])
                item.description  =  line.match(/^\[\d+]\s*\d+(.+)/)[1].trim()
                item.valueBinary = parseInt(item.value).toString(2)
                if(item.valueBinary.length <= item.size){
                    item.bits = item.valueBinary.padStart(item.size, '0')
                }
                else{
                    item.bits = '#overflow'
                    item.error = 'overflow: '+ item.value + ' needs ' + item.valueBinary.length + ' bits'
                }
            }
            else{
                item.error = 'wrong format: ' + line
            }
            fields.push(item)
        }

        return fields
    }

    function scheme2bits(scheme)
    {
        const fields = compile(scheme)

        const fieldWithErrors = fields.filter(x=>x.error)
        if(fieldWithErrors.length > 0){
            alert(fieldWithErrors.map(x=>x.error).join("\n"))
        }

        return fields.map(x=>x.bits).join(' ')
    }

    function scheme2hex(scheme)
    {
        const bits = scheme2bits(scheme)
        const binaryString = bits.replace(/\s+/g, '')

        let output = ''

        // For every 4 bits in the binary string
        for (let i = 0; i < binaryString.length; i += 4)
        {
            // Grab a chunk of 4 bits
            const bytes = binaryString.substr(i, 4)

            // Convert to decimal then hexadecimal
            const decimal = parseInt(bytes, 2)
            const hex = decimal.toString(16)

            // Uppercase all the letters and append to output
            output += hex.toUpperCase();
        }

        return output;
    }

    function createUrl(scheme)
    {
        const currentUrl = location.protocol+'//'+
            location.host+
            location.pathname+
            (location.search?location.search:"")

        return currentUrl + '#' + encodeURIComponent(scheme.replace(/\n/g, '|'))
    }

    function hex2bin(hex) {
        let result = ''
        for (let i = 0; i < hex.length; i++) {
            result += parseInt(hex.charAt(i), 16).toString(2).padStart(4, '0')
        }
        return result
    }

    function explain()
    {
        const hex = document.getElementById('hex').value.replaceAll(' ', '')
        const numberOfBits = hex.length * 4
        const binary = hex2bin(hex)

        const scheme = document.getElementById('scheme').value
        const fields = compile(scheme)
        const expectedSize = fields.map(x=>parseInt(x.size)).reduce((a,b)=>a+b,0)

        if(numberOfBits !== expectedSize){
            alert(`Wrong message length!\nScheme size: ${expectedSize} bits\nMessage size: ${numberOfBits} bits`)
            return
        }

        let out = ''
        let offset = 0

        for(const f of fields)
        {
            const valueBinary = binary.substring(offset, offset + f.size)
            out += "\n"
            out += `<b>${f.description} </b>`
            out += `<small style="width: 80px; display: inline-block">${f.size} bit ${offset}..${offset+f.size}</small>`
            out += "\n"
            out += `<span style="color: white; background-color: gray; padding:1px 3px;"/><b>${parseInt(valueBinary, 2)}</b></span> `
            out += `<span  style="color: brown; "/>b${valueBinary}</span>`
            out += "\n"

            offset += f.size
        }

        document.getElementById('explain-output').innerHTML = out;
    }


    function updateSchemeValues()
    {
        const scheme = document.getElementById('scheme').value

        const hex = document.getElementById('hex').value.replaceAll(' ', '')
        const binary = hex2bin(hex)

        let offset = 0
        const replaced = scheme.replace(/\[(\d+)]\s*(\d+)/g, (all, sz, val) => {
            sz = parseInt(sz)
            let valueBinary = binary.substring(offset, offset + sz)
            valueBinary = valueBinary === '' ? 0 : valueBinary
            let value = parseInt(valueBinary, 2)
            offset += sz
            return `[${sz}] ${value}`
        })
        document.getElementById('scheme').value = replaced;
    }

</script>


<br>
<br>
<br>

<button onclick="location.href = '#'">CLEAR</button>
<a href="javascript:" onclick="prompt('COPY URL HERE:',createUrl(document.getElementById('scheme').value))">get link</a>
<br>
<br>

<div style="display: flex">
    <div>
        BITWISE SCHEME:<br>
        <textarea id=scheme cols=60 rows=25 style=""></textarea>
        <br><br>
        <button onclick="build()">BUILD HEX</button>
    </div>
    <div style="margin-left: 100px">
        Format hint:
        <pre>#commented line<br>[{size}] {value} {description}<br>[{size}] {value} {description}<br>...</pre>
        Examples:<br>
        <a href="## сообщение OFTEN (1 фаза)||[3] 0  cmd|[1] 0  флаг экспорта|[6] 0  год|[4] 11 месяц|[5] 18 день|[5] 23 час|[1] 1  получас||[3] 2  номер тарифа|[23] 0 актив|[23] 8388607 реакт|[6] 0 напр">
            ElectroX: Often (1 фаза)
        </a><br>
        <a href="## сообщение OFTEN (3 фазы)||[3] 1  cmd|[1] 0  флаг экспорта|[6] 0  год|[4] 11 месяц|[5] 18 день|[5] 23 час|[1] 1  получас||[3]  2  номер тарифа|[23] 0 фаза1 актив |[23] 0 фаза1 реакт|[6]  0 фаза1 напр|[23] 0 фаза2 актив |[23] 0 фаза2 реакт|[6]  0 фаза2 напр|[23] 0 фаза3 актив |[23] 0 фаза3 реакт|[6]  0 фаза3 напр">
            ElectroX: Often (3 фазы)
        </a><br>
        <a href="#%23%20%D1%81%D0%BE%D0%BE%D0%B1%D1%89%D0%B5%D0%BD%D0%B8%D0%B5%20DAILY%20(1%20%D1%84%D0%B0%D0%B7%D0%B0%2C%201%20%D1%82%D0%B0%D1%80%D0%B8%D1%84)%7C%7C%5B3%5D%202%20%20cmd%7C%5B1%5D%200%20%20%D1%84%D0%BB%D0%B0%D0%B3%20%D1%8D%D0%BA%D1%81%D0%BF%D0%BE%D1%80%D1%82%D0%B0%7C%7C%5B6%5D%200%20%20%D0%B3%D0%BE%D0%B4%7C%5B4%5D%2011%20%D0%BC%D0%B5%D1%81%D1%8F%D1%86%7C%5B5%5D%2018%20%D0%B4%D0%B5%D0%BD%D1%8C%7C%7C%5B3%5D%201%20%D1%87%D0%B8%D1%81%D0%BB%D0%BE%20%D1%82%D0%B0%D1%80%D0%B8%D1%84%D0%BE%D0%B2%7C%5B24%5D%200%20%D0%B0%D0%BA%D1%82%D0%B8%D0%B2%20%D1%821%7C%5B24%5D%200%20%D1%80%D0%B5%D0%BA%D1%82%D0%B8%D0%B2%20%D1%821%7C%7C%5B2%5D%200%20%D0%B2%D1%8B%D1%80%D0%B0%D0%B2%D0%BD%D0%B8%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%B4%D0%BE%20%D0%B1%D0%B0%D0%B9%D1%82%D0%B0">
            ElectroX: Daily (1 фаза, 1 тариф)
        </a><br>
        <a href="#%23%20%D1%81%D0%BE%D0%BE%D0%B1%D1%89%D0%B5%D0%BD%D0%B8%D0%B5%20EVENT%7C%7C%5B4%5D%208%20%20cmd%7C%7C%5B6%5D%200%20%20%D0%B3%D0%BE%D0%B4%7C%5B4%5D%2011%20%D0%BC%D0%B5%D1%81%D1%8F%D1%86%7C%5B5%5D%2018%20%D0%B4%D0%B5%D0%BD%D1%8C%7C%5B5%5D%2023%20%D1%87%D0%B0%D1%81%7C%5B6%5D%200%20%20%D0%BC%D0%B8%D0%BD%D1%83%D1%82%D1%8B%7C%5B6%5D%200%20%20%D1%81%D0%B5%D0%BA%D1%83%D0%BD%D0%B4%D1%8B%7C%7C%5B8%5D%201%20event_id%7C">
            ElectroX: Event
        </a><br>
        <a href="#%23%20DL%20%D1%81%D0%BE%D0%BE%D0%B1%D1%89%D0%B5%D0%BD%D0%B8%D0%B5%20%D1%81%D0%B8%D0%BD%D1%85%D1%80%D0%BE%D0%BD%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%20%D0%B2%D1%80%D0%B5%D0%BC%D0%B5%D0%BD%D0%B8%7C%7C%5B4%5D%209%20%20cmd%7C%5B6%5D%200%20%20%D0%B3%D0%BE%D0%B4%7C%5B4%5D%2011%20%D0%BC%D0%B5%D1%81%D1%8F%D1%86%7C%5B5%5D%2018%20%D0%B4%D0%B5%D0%BD%D1%8C%7C%5B5%5D%2023%20%D1%87%D0%B0%D1%81%7C%5B6%5D%201%20%20min%7C%5B6%5D%201%20%20sec%7C">
            ElectroX: DL Sync Time
        </a><br>
        <br>
        <a href="#%23%20Electro1F%20-%20%D1%81%D0%BE%D0%BE%D0%B1%D1%89%D0%B5%D0%BD%D0%B8%D0%B5%20OFTEN%20%7C%7C%5B4%5D%20%200%20pktid%7C%5B23%5D%201%20fnxTime%7C%7C%5B24%5D%20333%20%D0%B0%D0%BA%D1%82%D0%B8%D0%B2%7C%5B24%5D%20444%20%D1%80%D0%B5%D0%B0%D0%BA%D1%82%7C%5B1%5D%20%200%20%20%20voltage%20sign%7C%5B4%5D%20%2010%20%20voltage%20value">
            Electro1F: Often Import
        </a><br>
    </div>
    <div style="margin-left: 100px; background-color: #eee">
        <div>Parse hex</div>
        <input id="hex" style="width: 400px">
        <button onclick="explain()">explain</button>
        <button onclick="updateSchemeValues()" title="update scheme values">up</button>

        <div id="explain-output" style="white-space: pre-line"></div>
    </div>
</div>


<br>

<br>
<br>

<textarea id=output rows=5 style="width: 100%">
</textarea>
